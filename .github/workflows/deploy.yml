  name: Deploy Capstone IAM Project

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: capstone-iam-project

jobs:
  validate:
    name: Validate Scripts
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Validate script syntax
      run: |
        echo "Validating script syntax..."
        find . -name "*.sh" -exec bash -n {} \;
        echo "✅ All scripts have valid syntax"

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Set up execute permissions
      run: chmod +x *.sh

    - name: Validate AWS credentials
      run: |
        echo "Validating AWS credentials..."
        aws sts get-caller-identity
        echo "✅ AWS credentials validated"

    - name: Run deployment
      run: |
        echo "Starting CAPSTONE project deployment..."
        ./capstone-deploy-working.sh
        echo "✅ Deployment completed successfully"

    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-results
        path: |
          .capstone-resources
          capstone-deployment-report.txt
        retention-days: 7
